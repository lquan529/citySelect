/**
 * citySelect
 * v-1.0.1
 * author：lquan
 * https://github.com/lquan529/citySelect
 */

(function($,window){var functionality={};function Cityselect(options,selector){this.options=$.extend({},Cityselect.defaults,options);this.$selector=$(selector);this.multiSelectResult=[];this.multiSelectResultId=[];this.provinceId=[];this.values=[];this.selectIndex=0;this.isfocus=true;this.init()}Cityselect.defaults={dataJson:null,convert:true,shorthand:false,search:true,multiSelect:false,multiMaximum:5,multiType:0,mosaic:",",placeholder:"请选择城市",searchPlaceholder:"输入关键词搜索",hotCity:[],onInit:function(){},onForbid:function(){},onTabsAfter:function(target){},onTabsForbid:function(target){},onCallerAfter:function(target,values){}};functionality.recombine=function(data){var resultId=[],result=[],province=[];$.each(data,function(key,value){if(value.parentId==="100000"){resultId.push(value.id);province.push(value)}});for(var i=0;i<resultId.length;i++){$.each(data,function(key,value){if(resultId[i]===value.parentId){result.push(value)}})}this.province=province;return result};functionality.filter=function(parameter){var configure=parameter;parameter.filterCity={HOT:[],A:[],B:[],C:[],D:[],E:[],F:[],G:[],H:[],I:[],J:[],K:[],L:[],M:[],N:[],O:[],P:[],Q:[],R:[],S:[],T:[],U:[],V:[],W:[],X:[],Y:[],Z:[]};$.each(configure.newCityData,function(key,value){switch(value.letter){case ("A"):parameter.filterCity.A.push(value);break;case ("B"):parameter.filterCity.B.push(value);break;case ("C"):parameter.filterCity.C.push(value);break;case ("D"):parameter.filterCity.D.push(value);break;case ("E"):parameter.filterCity.E.push(value);break;case ("F"):parameter.filterCity.F.push(value);break;case ("G"):parameter.filterCity.G.push(value);break;case ("H"):parameter.filterCity.H.push(value);break;case ("I"):parameter.filterCity.I.push(value);break;case ("J"):parameter.filterCity.J.push(value);break;case ("K"):parameter.filterCity.K.push(value);break;case ("L"):parameter.filterCity.L.push(value);break;case ("M"):parameter.filterCity.M.push(value);break;case ("N"):parameter.filterCity.N.push(value);break;case ("O"):parameter.filterCity.O.push(value);break;case ("P"):parameter.filterCity.P.push(value);break;case ("Q"):parameter.filterCity.Q.push(value);break;case ("R"):parameter.filterCity.R.push(value);break;case ("S"):parameter.filterCity.S.push(value);break;case ("T"):parameter.filterCity.T.push(value);break;case ("U"):parameter.filterCity.U.push(value);break;case ("V"):parameter.filterCity.V.push(value);break;case ("W"):parameter.filterCity.W.push(value);break;case ("X"):parameter.filterCity.X.push(value);break;case ("Y"):parameter.filterCity.Y.push(value);break;case ("Z"):parameter.filterCity.Z.push(value);break;default:}if(parameter.options.hotCity.length<1&&key<18){parameter.filterCity.HOT.push(value)}else{$.each(parameter.options.hotCity,function(hkey,hvaluef){if(hvaluef===value.name){parameter.filterCity.HOT.push(value)}})}});return parameter.filterCity};functionality.montage=function(citydata,letter){var self=this,data=citydata===0?self.filterCity:citydata,html="",name;$.each(data,function(key,value){name=self.options.shorthand?value.shortName:value.name;if(citydata<1){if(letter===key){$.each(value,function(lkey,lvalue){name=self.options.shorthand?lvalue.shortName:lvalue.name;html+='<a href="javascript:;" class="caller" data-parentid="'+lvalue.parentId+'" data-id="'+lvalue.id+'" data-title="'+name+'" data-letter="'+lvalue.letter+'">'+name+"</a>"})}}else{html+='<li class="caller" data-parentid="'+value.parentId+'" data-id="'+value.id+'" data-title="'+name+'" data-letter="'+value.letter+'">'+'<span class="name">'+name+"</span>"+'<span class="spell">'+value.pinyin+"</span>"+"</li>"}});return html};functionality.template=['<div class="city-pavilion hide">','<div class="city-tabs">','<a href="javascript:;" class="tab-a active" data-letter="HOT">热门城市</a>','<a href="javascript:;" class="tab-a" data-letter="AB">AB</a>','<a href="javascript:;" class="tab-a" data-letter="CD">CD</a>','<a href="javascript:;" class="tab-a" data-letter="EFG">EFG</a>','<a href="javascript:;" class="tab-a" data-letter="HI">HI</a>','<a href="javascript:;" class="tab-a" data-letter="JK">JK</a>','<a href="javascript:;" class="tab-a" data-letter="LM">LM</a>','<a href="javascript:;" class="tab-a" data-letter="NOP">NOP</a>','<a href="javascript:;" class="tab-a" data-letter="QR">QR</a>','<a href="javascript:;" class="tab-a" data-letter="S">S</a>','<a href="javascript:;" class="tab-a" data-letter="TU">TU</a>','<a href="javascript:;" class="tab-a" data-letter="VWX">VWX</a>','<a href="javascript:;" class="tab-a" data-letter="Y">Y</a>','<a href="javascript:;" class="tab-a" data-letter="Z">Z</a>',"</div>",'<div class="city-cont">',"{cont}","<p>",'<a href="javascript:;" class="empty"><i></i>清空</a><span></span>',"<em>*可以直接搜索查找城市（支持名称、拼音模糊搜索）</em>","</p>","</div>","</div>",'<div class="city-info{type}">',"{name}",'<div class="city-input {not}">','<input type="text" class="input-search" value="" placeholder="{placeholder}" />',"</div>","</div>",'<ul class="city-list hide"></ul>','<div class="city-tips hide">最多只能选择<span>{maxnum}</span>项</div>'];
functionality.split=function(str){var letArray=[];for(var i=0;i<str.length;i++){letArray.push(str[i])}return letArray};functionality.groupArray=["HOT","AB","CD","EFG","HI","JK","LM","NOP","QR","S","TU","VWX","Y","Z"];functionality.showDrop=function(event){var self=this,configure=self.options,$target=$(event.target);if($(event.currentTarget).hasClass("forbid")){configure.onForbid.call(self);return false}if($target.hasClass("del")){functionality.deletes.call(self,$target);return false}self.isfocus=true;self.$selector.addClass("down").find(".city-pavilion").removeClass("hide").siblings(".city-list").addClass("hide");$(event.currentTarget).find(".input-search").focus();functionality.defSelected.call(self)};functionality.tabs=function(event){var $target=$(event.target),configure=this.options,letter=$target.data("letter");if($target.hasClass("forbid")){configure.onTabsForbid.call(self,$target);return false}$target.addClass("active").siblings().removeClass("active");this.$selector.find("dl").addClass("hide").siblings(".city-"+letter).removeClass("hide");configure.onTabsAfter.call(this,$target)};functionality.singleAchieve=function(event){var $target=$(event.currentTarget),$input=this.$selector.find(".input-search"),$cityInfo=this.$selector.find(".city-info"),configure=this.options,parentId=$target.attr("data-parentid"),id=$target.attr("data-id"),name=$target.data("title");this.values=[];this.values.push({"name":name,"id":id,"parentId":parentId});this.$selector.find(".caller").removeClass("active");this.$selector.find('.caller[data-id="'+id+'"]').addClass("active");$cityInfo.find("span").remove();this.$selector.find(".city-input").before('<span data-id="'+id+'" data-parentid="'+parentId+'">'+name+'<i class="del"></i></span>').find(".input-search").val("");functionality.singleResize.call(this);this.$selector.removeClass("down").find(".city-pavilion, .city-list").addClass("hide");if(!this.options.search&&this.values.length>0){this.$selector.find(".city-input").addClass("hide")}configure.onCallerAfter.call(this,$target,this.values[0])};functionality.multiAchieve=function(event){var self=this,$selector=self.$selector,$target=$(event.currentTarget),$input=$selector.find(".input-search"),configure=self.options,parentId=$target.attr("data-parentid"),id=$target.attr("data-id"),name=$target.data("title"),inputVal=$input.val(),hasActive=$target.hasClass("active"),joinSpan,mosaicName;if(!hasActive){if(self.selectIndex>=configure.multiMaximum){$selector.find(".city-tips").removeClass("hide");setTimeout(function(){$selector.find(".city-tips").addClass("hide")},1000);return false}if($.inArray(name,self.multiSelectResult)<0){self.multiSelectResult.push(name);self.multiSelectResultId.push(id);self.provinceId.push(parentId);joinSpan='<span data-id="'+id+'" data-parentid="'+parentId+'">'+name+'<i class="del"></i></span>';$selector.find('.caller[data-id="'+id+'"]').addClass("active");if(configure.multiType<1){$selector.find(".city-input").before(joinSpan)}self.selectIndex+=1}}else{self.multiSelectResult.splice($.inArray(name,self.multiSelectResult),1);self.multiSelectResultId.splice($.inArray(id,self.multiSelectResultId),1);self.provinceId.splice($.inArray(parentId,self.provinceId),1);$selector.find('.caller[data-id="'+id+'"]').removeClass("active");$selector.find(".city-info").find('span[data-id="'+id+'"]').remove();self.selectIndex-=1}self.values=[];self.multiSelectResult.length>0?self.values.push({"name":self.multiSelectResult,"id":self.multiSelectResultId,"parentId":self.provinceId}):"";mosaicName=self.multiSelectResult.join(configure.mosaic);if(configure.multiType===1){$selector.find(".city-name").html('<span class="span-over" title="'+mosaicName+'">'+mosaicName+"</span>")}if(self.selectIndex<1){$selector.find(".city-input").addClass("not-val");$selector.find(".span-over").remove()}else{$selector.find(".city-input").removeClass("not-val")}$selector.find("p").find("span").text(self.selectIndex>0?self.selectIndex:"");configure.onCallerAfter.call(self,$target,self.values[0])};functionality.search=function(event){var self=this,$target=$(event.target),configure=this.options,keyCode=event.keyCode,inputVal=$target.val(),result=[],resultHtml;if(keyCode===16||keyCode===17||keyCode===18||keyCode===37||keyCode===39||keyCode===91||keyCode===93){return false}if(keyCode!==13&&keyCode!==38&&keyCode!==40){self.isfocus=false;$.each(self.newCityData,function(key,value){if(value.pinyin.toLocaleLowerCase().search(inputVal.toLocaleLowerCase())>-1||value.name.search(inputVal)>-1||value.id.search(inputVal)>-1){result.push(value)}});resultHtml=result.length>0?functionality.montage.call(self,result):'<li class="not-have">没有找到<strong>'+inputVal+"</strong>相关城市</li>";self.$selector.find(".city-list").html(resultHtml);functionality.defSelected.call(self);functionality.searchShow.call(self)}return false};functionality.searchShow=function(event){this.$selector.addClass("down").find(".city-pavilion").addClass("hide");this.$selector.find(".city-input").addClass("search-show");
this.$selector.find(".city-list").removeClass("hide")};functionality.defSelected=function(event){var self=this;if(self.values[0].id instanceof Array){$.each(self.values[0].id,function(key,value){self.$selector.find('.caller[data-id="'+value+'"]').addClass("active")})}else{self.$selector.find('.caller[data-id="'+self.values[0].id+'"]').addClass("active")}};functionality.operation=function(event){var self=this,$selector=self.$selector,$cityList=$selector.find(".city-list"),$target=$(event.target),$items=$cityList.find(".caller"),hasNothave=$cityList.find("li").hasClass("not-have"),keyCode=event.keyCode,index=0,direction,itemIndex;if(keyCode===13){$cityList.find(".caller.hover").trigger("click");return false}if(keyCode===38||keyCode===40){direction=keyCode===38?-1:1;itemIndex=$items.index($cityList.find(".caller.hover"));if(itemIndex<0){index=direction>0?-1:0}else{index=itemIndex}index=index+direction;index=index===$items.length?0:index;$items.removeClass("hover").eq(index).addClass("hover");if(!hasNothave){functionality.scroll.call(self)}return false}};functionality.scroll=function(event){var self=this,$cityList=self.$selector.find(".city-list"),$callerHover=$cityList.find(".caller.hover"),oh=$cityList.outerHeight(),ch=$callerHover.outerHeight()+1,dy=$callerHover.position().top,sy=$cityList.scrollTop();$cityList.animate({scrollTop:dy+ch-oh+sy},200)};functionality.singleResize=function(){var self=this,$selector=self.$selector,$cityInfo=$selector.find(".city-info"),_iw=$cityInfo.outerWidth(),_p=$cityInfo.innerWidth()-$cityInfo.width(),_sw=$cityInfo.find("span").outerWidth(true);$selector.find(".city-input").width(_iw-_sw-_p-2)};functionality.multiResize=function(){var self=this,$selector=self.$selector,_h=$selector.outerHeight(true)-1;$selector.find(".city-pavilion, .city-list").animate({"top":_h},10)};functionality.forbid=function(){var self=this;$.each(self.$selector.find(".city-cont").find("dl"),function(key,value){var _this=$(value),_letter=_this.data("letter");if(!$(value).text()){self.$selector.find('.tab-a[data-letter="'+_letter+'"]').addClass("forbid")}})};functionality.deletes=function(target){var self=this,$target=target,$parent=$target.parent(),name=$parent[0].innerText,id=$parent.attr("data-id"),parentId=$parent.data("parentid");self.multiSelectResult.splice($.inArray(name,self.multiSelectResult),1);self.multiSelectResultId.splice($.inArray(id,self.multiSelectResultId),1);self.provinceId.splice($.inArray(parentId,self.provinceId),1);self.values=[];self.multiSelectResult.length>0?self.values.push({"name":self.multiSelectResult,"id":self.multiSelectResultId,"parentId":self.provinceId}):"";$parent.remove();self.$selector.find('.caller[data-id="'+id+'"]').removeClass("active");if(self.options.multiSelect){self.selectIndex-=1;self.$selector.find("p").find("span").text(self.selectIndex>0?self.selectIndex:"");self.values.length<1?self.$selector.find(".city-input").addClass("not-val"):""}else{functionality.singleResize.call(self)}};Cityselect.prototype.init=function(){var self=this,configure=this.options;self.newCityData=configure.convert?functionality.recombine.call(self,configure.dataJson):configure.dataJson;functionality.filter(self);self.createSubject();self.bindEvent();configure.onInit.call(self)};Cityselect.prototype.groupCity=function(){var self=this,domtel="",letterStr,groupArray,list,montage,hide;for(var i=0;i<functionality.groupArray.length;i++){groupArray=functionality.groupArray[i];letterStr=groupArray!=="HOT"?functionality.split(groupArray):"";hide=i>0?" hide":"";domtel+='<dl class="city-'+groupArray+hide+'" data-letter="'+groupArray+'">{dl}</dl>';if(letterStr&&letterStr.length>1){list="";for(var j=0;j<letterStr.length;j++){montage=functionality.montage.call(self,0,letterStr[j]);if(montage){list+="<dt>"+letterStr[j]+"</dt>"+"<dd>"+montage+"</dd>"}}}else{montage=functionality.montage.call(self,0,groupArray);if(montage){list=groupArray!=="HOT"?"<dt>"+groupArray+"</dt>"+"<dd>"+functionality.montage.call(self,0,groupArray)+"</dd>":"<dd>"+functionality.montage.call(self,0,groupArray)+"</dd>"}}domtel=domtel.replace("{dl}",list)}return domtel};Cityselect.prototype.createSubject=function(){var self=this,configure=self.options,template=functionality.template.join("");template=template.replace("{placeholder}",configure.searchPlaceholder);template=template.replace("{maxnum}",configure.multiMaximum);template=template.replace("{type}",configure.multiType===1?" multi-type":"");template=template.replace("{name}",configure.multiType===1?'<div class="city-name"></div>':"");configure.multiSelect?self.$selector.addClass("multi"):"";template=template.replace("{not}","not-val not-search");self.$selector.html(template.replace("{cont}",self.groupCity()));if(!configure.search){self.$selector.find(".city-input").addClass("not-search").html("<em>"+configure.placeholder+"</em>");self.$selector.find(".city-cont").find("p").find("em").remove()}else{self.$selector.find(".city-input").removeClass("not-search")}functionality.forbid.call(self)
};Cityselect.prototype.bindEvent=function(event){var self=this,configure=self.options,$selector=self.$selector;$selector.on("click.cityselect",".city-info",$.proxy(functionality.showDrop,self));$selector.on("click.cityselect",".tab-a",$.proxy(functionality.tabs,self));$selector.on("click.cityselect",".caller",$.proxy(configure.multiSelect?functionality.multiAchieve:functionality.singleAchieve,self));$selector.on("click.cityselect",".empty",$.proxy(self.clear,self));$selector.on("keyup.cityselect",".input-search",$.proxy(functionality.search,self));$selector.on("keydown.cityselect",$.proxy(functionality.operation,self))};Cityselect.prototype.unBindEvent=function(event){var self=this,$selector=self.$selector;$selector.off("click.cityselect",".city-info");$selector.off("click.cityselect",".tab-a");$selector.off("click.cityselect",".caller");$selector.off("click.cityselect",".empty");$selector.off("keyup.cityselect",".input-search");$selector.off("keydown.cityselect")};Cityselect.prototype.setCityVal=function(val){var self=this,configure=self.options,setCity=val.replace(/\s/g,""),cityArray=setCity.split(","),name,joinSpan,mosaicName;if(val){self.cityVal=val;!configure.multiSelect?cityArray=cityArray.splice(0,1):cityArray=cityArray.splice(0,configure.multiMaximum);for(var i=0;i<cityArray.length;i++){$.each(self.newCityData,function(key,value){name=self.options.shorthand?value.shortName:value.name;if(cityArray[i]===value.name){self.multiSelectResult.push(name);self.multiSelectResultId.push(value.id);self.provinceId.push(value.parentId);self.$selector.find('.caller[data-id="'+value.id+'"]').addClass("active");joinSpan='<span data-id="'+value.id+'" data-parentid="'+value.parentId+'">'+name+'<i class="del"></i></span>';if(configure.multiType<1){self.$selector.find(".city-input").before(joinSpan)}}});if(self.options.multiSelect){self.selectIndex=i+1;self.$selector.find("p").find("span").text(i+1)}}self.values=[];self.multiSelectResult.length>0?self.values.push({"name":self.multiSelectResult,"id":self.multiSelectResultId,"parentId":self.provinceId}):"";mosaicName=self.multiSelectResult.join(configure.mosaic);if(configure.multiType===1){self.$selector.find(".city-name").html('<span class="span-over" title="'+mosaicName+'">'+mosaicName+"</span>")}self.values.length>0?self.$selector.find(".city-input").removeClass("not-val"):""}};Cityselect.prototype.getCityVal=function(){return this.values[0]};Cityselect.prototype.update=function(data){var self=this,template=functionality.template.join("");if(data.length>0){self.newCityData=data;functionality.filter(self);self.createSubject();self.cityVal?self.setCityVal(self.cityVal):""}};Cityselect.prototype.clear=function(){this.multiSelectResult=[];this.multiSelectResultId=[];this.provinceId=[];this.values=[];this.selectIndex=0;this.isfocus?this.$selector.find(".input-search").val("").focus():"";this.$selector.find(".caller").removeClass("active");this.$selector.find("p").find("span").text("");this.$selector.find(".city-info").find("span").remove();if(this.values.length<1){this.$selector.find(".city-input").removeClass("hide").addClass("not-val")}};Cityselect.prototype.status=function(status){var self=this,$cityInfo=self.$selector.find(".city-info");if(status==="disabled"){self.$selector.addClass("disabled").find(".input-search").prop("disabled",true);self.unBindEvent()}else{if(status==="readonly"){self.$selector.addClass("readonly").find(".input-search").prop("readonly",true);self.unBindEvent()}}};$(document).on("click.cityselect",function(event){var $citySelect=$(".city-select");if($citySelect.find(event.target).length<1){$citySelect.removeClass("down").find(".city-pavilion, .city-list").addClass("hide");$citySelect.find(".city-input").removeClass("search-show").find(".input-search").val("")}});$.fn.citySelect=function(options){return new Cityselect(options,this)}})(jQuery,window);